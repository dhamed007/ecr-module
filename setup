variable "domain_name" {
  description = "The name of the CodeArtifact domain"
}

variable "repository_name" {
  description = "The name of the CodeArtifact repository"
}

variable "kms_key_description" {
  description = "The description for the KMS key"
}
--
resource "aws_kms_key" "codeartifact_key" {
  description = var.kms_key_description
}

resource "aws_codeartifact_domain" "codeartifact_domain" {
  domain         = var.domain_name
  encryption_key = aws_kms_key.codeartifact_key.arn
}

resource "aws_codeartifact_repository" "codeartifact_repository" {
  repository = var.repository_name
  domain     = aws_codeartifact_domain.codeartifact_domain.domain

  external_connections {
    external_connection_name = "public:maven-central"
  }
}
---
output "maven_settings" {
  value = <<-EOT
    <settings>
      <mirrors>
        <mirror>
          <id>codeartifact</id>
          <mirrorOf>*,!maven-central</mirrorOf>
          <url>https://${aws_codeartifact_domain.codeartifact_domain.domain}.d.codeartifact.${var.region}.amazonaws.com/maven/${var.repository_name}/</url>
          <settings>
            <xmlui>false</xmlui>
          </settings>
        </mirror>
      </mirrors>
    </settings>
  EOT
}resource "aws_codeartifact_domain_permissions_policy" "examplea" {
  domain          = aws_codeartifact_domain.examplea.domain
  policy_document = <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": "codeartifact:CreateRepository",
            "Effect": "Allow",
            "Principal": "*",
            "Resource": "${aws_codeartifact_domain.examplea.arn}"
        }
    ]
}
EOF
}
---

--------------------------------

resource "aws_codeartifact_domain" "examplea" {
  domain         = var.domain
  encryption_key = var.kms_key.arn
  tags           = var.common_tags
}
---

resource "aws_codeartifact_repository" "examplea" {
  repository = var.repository
  domain     = aws_codeartifact_domain.examplea.domain
  tags       = var.common_tags
}
---

resource "aws_codeartifact_domain_permissions_policy" "examplea" {
  domain          = aws_codeartifact_domain.examplea.domain
  policy_document = <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": "codeartifact:CreateRepository",
            "Effect": "Allow",
            "Principal": "*",
            "Resource": "${aws_codeartifact_domain.examplea.arn}"
        }
    ]
}
EOF
}
---
resource "aws_codeartifact_repository_permissions_policy" "examplea" {
  repository      = aws_codeartifact_repository.examplea.repository
  domain          = aws_codeartifact_domain.examplea.domain
  policy_document = <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": "codeartifact:CreateRepository",
            "Effect": "Allow",
            "Principal": "*",
            "Resource": "${aws_codeartifact_domain.examplea.arn}"
        }
    ]
}
EOF
}
---


variable "common_tags" {
  description = "This is to help you add tags to your cloud objects"
  type        = map(any)
}

variable "repository" {
  type    = string
  default = "freebeer"
}

variable "domain" {
  type    = string
  default = "freebeer"
}

variable "kms_key" {

}
