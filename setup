variable "domain_name" {
  description = "The name of the CodeArtifact domain"
}

variable "repository_name" {
  description = "The name of the CodeArtifact repository"
}

variable "kms_key_description" {
  description = "The description for the KMS key"
}
--
resource "aws_kms_key" "codeartifact_key" {
  description = var.kms_key_description
}

resource "aws_codeartifact_domain" "codeartifact_domain" {
  domain         = var.domain_name
  encryption_key = aws_kms_key.codeartifact_key.arn
}

resource "aws_codeartifact_repository" "codeartifact_repository" {
  repository = var.repository_name
  domain     = aws_codeartifact_domain.codeartifact_domain.domain

  external_connections {
    external_connection_name = "public:maven-central"
  }
}
---
output "maven_settings" {
  value = <<-EOT
    <settings>
      <mirrors>
        <mirror>
          <id>codeartifact</id>
          <mirrorOf>*,!maven-central</mirrorOf>
          <url>https://${aws_codeartifact_domain.codeartifact_domain.domain}.d.codeartifact.${var.region}.amazonaws.com/maven/${var.repository_name}/</url>
          <settings>
            <xmlui>false</xmlui>
          </settings>
        </mirror>
      </mirrors>
    </settings>
  EOT
}
